<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tm.cgv.seat.SeatRepository">

 	<insert id="seatInsert" parameterType="SeatVO">
		insert into seat (theaterNum, rowIdx, colIdx, grade)
		values(#{theaterNum},#{rowIdx},#{colIdx},#{grade})
	</insert>
	
	<select id="theaterSelect" resultType="Integer">
		select max(num) from theater;
	</select>


	<resultMap type="SeatVO" id="SeatResul">

		<id column="num" property="num"/>
		<result column="theaterNum" property="theaterNum"/>
		<result column="rowIdx" property="rowIdx"/>
		<result column="colIdx" property="colIdx"/>
		<result column="grade" property="grade"/>
		
		<association property="seatBookingVO" javaType="SeatBookingVO">
			<id column="bNum" property="num"/>
			<result column="seatNum" property="seatNum"/>
			<result column="movieTimeNum" property="movieTimeNum"/>
			<result column="reservationNum" property="reservationNum"/>	
		</association>		
	
	</resultMap>




 	<select id="seatSelectOne" parameterType="SeatVO" resultType="SeatVO">
		<!-- select * from seat where theaterNum = #{theaterNum} order by 3, col -->
		select * from 
		(select * from seat where theaterNum = #{theaterNum} order by rowIdx, colIdx) S
		left join
		(select num as bNum,seatNum,movieTimeNum,reservationNum from seatBooking where movieTimeNum = #{movieTimeNum}) SB
		on(S.num = SB.seatNum)
 	</select>
 	
 	<select id="rowCount" parameterType="SeatVO" resultType="SeatVO">
 		select rowIdx,grade from (select rowIdx,grade from seat where theaterNum = #{theaterNum} group by rowIdx,grade order by rowIdx) A
 	</select>
 	
 	<select id="colCount" parameterType="SeatVO" resultType="Integer">
 		select max(colIdx) from seat where theaterNum = #{theaterNum}
 	</select>
	
 

</mapper>