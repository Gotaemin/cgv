<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tm.cgv.movieInfo.MovieInfoRepository">
 	
 	<resultMap type="MovieInfoVO" id="listResult">
 		<id column="num" property="num"/>
 		<result column="title" property="title"/>
 		<result column="titleEng" property="titleEng"/>
 		<result column="runtime" property="runtime"/>
 		<result column="director" property="director"/>
 		<result column="actor" property="actor"/>
 		<result column="ganre" property="ganre"/>
 		<result column="ageLimit" property="ageLimit"/>
 		<result column="country" property="country"/>
 		<result column="openDate" property="openDate"/>
 		<result column="contents" property="contents"/>
 		<result column="visitor" property="visitor"/>
 		<result column="rate" property="rate"/>
 		<result column="errRate" property="errRate"/>
 		<result column="createAt" property="createAt"/>
 		
 		
 		<association property="movieImageVOs" javaType="MovieImageVO">
 			<id column="num" property="num"/>
 			<result column="movieNum" property="movieNum"/>
 			<result column="fileName" property="fileName"/>
 			<result column="originName" property="originName"/>
 			
 		</association>
 	</resultMap>
 	
 	<resultMap type="MovieInfoVO" id="movieJoin">
 		<id column="num" property="num"/>
 		<result column="title" property="title"/>
 		<result column="titleEng" property="titleEng"/>
 		<result column="runtime" property="runtime"/>
 		<result column="director" property="director"/>
 		<result column="actor" property="actor"/>
 		<result column="ganre" property="ganre"/>
 		<result column="ageLimit" property="ageLimit"/>
 		<result column="country" property="country"/>
 		<result column="openDate" property="openDate"/>
 		<result column="contents" property="contents"/>
 		<result column="visitor" property="visitor"/>
 		<result column="rate" property="rate"/>
 		<result column="errRate" property="errRate"/>
 		<result column="createAt" property="createAt"/>
 		
 		
 		<association property="movieImageVOs" javaType="MovieImageVO">
 			<id column="imageNum" property="num"/>
 			<result column="movieNum" property="movieNum"/>
 			<result column="fileName" property="fileName"/>
 			<result column="originName" property="originName"/>
 			
 		</association>
 		
 		<association property="movieVideoVOs" javaType="MovieVideoVO">
 			<id column="videoNum" property="num"/>
 			<result column="movieNum" property="movieNum"/>
 			<result column="videolink" property="videolink"/>
 			
 		 
 		</association>
 	</resultMap>
 	
 	
 	
 	
 	
 	
 	<select id="movieNumCount" resultType="Long">
 		select count(num) from movieInfo where deleteAt is null 
 		and title like concat('%',#{search},'%') order by
 		<choose>
			<when test="kind == 'date'">
				openDate desc
				
			</when>
			<when test="kind == 'title'">
				title asc
				
			</when>
			<otherwise>
				rate desc
				
			</otherwise>
		</choose>
 	</select>
 
 	
 
 	<select id="movieList" parameterType="Pager" resultMap="listResult">
 		select MM.* , MK.fileName,MK.originName,MK.movieNum from
 		(select * from
 		
 		(select * from movieInfo where title like concat('%',#{search},'%') and
 		deleteAt is null
 		order by
		<choose>
			<when test="kind == 'date'">
				openDate asc
				
			</when>
			<when test="kind == 'title'">
				title asc
				
			</when>
			<otherwise>
				rate desc
				
			</otherwise>
		</choose>
		limit #{startRow},#{perPage}) as PP ) as MM
		left join movieImage as MK
		on(MM.num = MK.movieNum)
		
		
		
 			
 	</select>
 	
 	<select id="movieListAll" parameterType="MovieInfoVO" resultType="MovieInfoVO">
 		select * from movieInfo ORDER by 
 			<choose>
 				<when test="kind == 'title'">
 					title asc
 				</when>
 				<otherwise>
 					rate desc
 				</otherwise>
 			</choose>
 			where deleteAt is null
 	 	</select>
 	 	
 	 	
 	 	
 	 	
 	 <insert id="movieWrite" parameterType="MovieInfoVO" useGeneratedKeys="true" keyProperty="num"> 
 	 	insert into movieInfo (num,title,titleEng,runtime,director,actor,ganre,ageLimit,country,openDate,contents,createAt)
 	 	values(#{num},#{title},#{titleEng},#{runtime},#{director},#{actor},#{ganre},#{ageLimit},#{country},#{openDate},#{contents},#{createAt})
 	 </insert>
 	 
 	 <select id="movieSelect" parameterType="MovieInfoVO" resultMap="movieJoin">
		select * from 
		(select * from 
		(select * from movieInfo) MI
		join 
		(select num as imageNum,fileName,originName,movieNum from movieImage) ME
		on (MI.num = ME.movieNum)) A
		join
		(select num as videoNum,movieNum,videolink  from movieVideo) MV
		on(A.num = MV.movieNum)
		where A.num=#{num} and deleteAt is null;
 	 </select>
 	 
 	<update id="movieUpdate" parameterType="MovieInfoVO">
 		update movieInfo set title=#{title},titleEng=#{titleEng},runtime=#{runtime},director=#{director},actor=#{actor},ganre=#{ganre},ageLimit=#{ageLimit},
 		country=#{country},openDate=#{openDate},contents=#{contents} where num=#{num}
 	</update>
 	
 	<update id="movieDelete" parameterType="MovieInfoVO">
 		update movieInfo set deleteAt=now() where num=#{num}
 	</update>
 	
 	<select id=""></select>
 	
 
 </mapper>