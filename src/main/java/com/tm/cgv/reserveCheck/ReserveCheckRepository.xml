<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tm.cgv.reserveCheck.ReserveCheckRepository">

	<resultMap type="ReserveCheckVO" id="reserverCheckResult">
		<collection property="movieInfoVOs" javaType="List" ofType="MovieInfoVO">
			<result column="mNum" property="num"/>
			<result column="title" property="title"/>
			<result column="rate" property="rate"/>
		</collection>
		
		<collection property="movieTimeVOs" javaType="List" ofType="MovieTimeVO">
			<result column="tNum" property="num"/>
			<result column="movieNum" property="movieNum"/>
			<result column="theaterNum" property="theaterNum"/>
			<result column="screenDate" property="screenDate"/>
			<result column="screenTime" property="screenTime"/>
			<result column="remainSeat" property="remainSeat"/>
			<result column="selectedFilm" property="selectedFilm"/>
		</collection>
		
		<collection property="theaterVOs" javaType="List" ofType="TheaterVO">
			<result column="sNum" property="num"/>
			<result column="cinemaNum" property="cinemaNum"/>
			<result column="name" property="name"/>
			<result column="seatCount" property="seatCount"/>
			
		</collection>
		
		<collection property="cinemaVOs" javaType="List" ofType="CinemaVO">
			<result column="cNum" property="num"/>
			<result column="cName" property="name"/>
		</collection>
	</resultMap>
	


	<select id="reservationCheckedSelect" parameterType="ReserveCheckVO" resultMap="reserverCheckResult">
		select * from
		(select * from 
		(select * from 
		(select * from 
		(select num as mNum,title,rate from movieInfo) M
		join
		(select num as tNum, movieNum, theaterNum,screenDate,screenTime,remainSeat,selectedFilm from movieTime
        where left(screenTime,2) >= date_format(sysdate(),'%H')
        or screenDate > sysdate()
        ) T
		on(M.mNum = T.movieNum)) A
		join
		(select num as sNum,cinemaNum,name,seatCount from theater) C
		on(C.sNum = A.theaterNum))B
		join
		(select num as cNum,name as cName from cinema) I
		on(I.cNum = B.cinemaNum)) F
		where F.cName Like concat('%',#{theater},'%') and F.screenDate Like concat('%',#{date},'%')
		<if test="num != 0">
			and F.mNum = #{num}
		</if>
        and screenDate > date_add(now(),interval -1 day)
        <choose>
        	<when test="kind =='sort'">
				order by title desc,cname        	
        	</when>
        	<otherwise>
        		order by rate,cname
        	</otherwise>
        </choose>
	</select>
 	
 
</mapper>